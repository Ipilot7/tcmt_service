{% extends 'base.html' %}
{% load i18n %}

{% block content %}
<div class="glass-container" style="max-width: 900px; margin: 0 auto;">
    <h2 style="color: black; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 10px;">
        {% if form.instance.pk %}
        ‚úèÔ∏è {% trans "Trip" %} {{ form.instance.request_number }}
        {% else %}
        ‚ûï {% trans "New Trip" %}
        {% endif %}
    </h2>

    <form method="post">
        {% csrf_token %}

        {% if form.non_field_errors %}
        <div
            style="color: #dc3545; background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 10px; border-radius: 4px; margin-bottom: 20px;">
            {{ form.non_field_errors }}
        </div>
        {% endif %}

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- Left Column -->
            <div>
                <h4 style="color: #6c757d; margin-bottom: 15px; border-bottom: 1px solid #dee2e6; padding-bottom: 5px;">
                    {% trans "General Information" %}</h4>

                <label>{% trans "Region" %}</label>
                {{ form.region }}

                <label>{% trans "Institution" %}</label>
                {{ form.institution }}

                <label>{% trans "Equipment Type" %}</label>
                {{ form.equipment_type }}

                <label>{% trans "Contact Phone (Object)" %}</label>
                {{ form.contact_phone }}

                <label>{% trans "Order Number" %}</label>
                {{ form.order_number }}

                <label>{% trans "Date" %}</label>
                {% if 'created_at' in form.fields %}
                {{ form.created_at }}
                {% else %}
                <input type="text" class="form-control" value="{{ form.instance.created_at|date:'d.m.Y' }}" disabled
                    style="background-color: #e9ecef;">
                {% endif %}
            </div>

            <!-- Right Column -->
            <div>
                <h4 style="color: #6c757d; margin-bottom: 15px; border-bottom: 1px solid #dee2e6; padding-bottom: 5px;">
                    {% trans "Execution Details" %}</h4>

                <label>{% trans "Responsible Employee" %}</label>
                {{ form.responsible }}

                <label>{% trans "Status" %}</label>
                {{ form.status }}

                <h4 style="color: #6c757d; margin: 25px 0 15px; border-bottom: 1px solid #dee2e6; padding-bottom: 5px;">
                    {% trans "Accompaniment" %}</h4>

                <label>{% trans "Escort Name" %}</label>
                {{ form.escort_name }}

                <label>{% trans "Escort Phone" %}</label>
                {{ form.escort_phone }}
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
            <div>
                <label>{% trans "Trip Reason" %}</label>
                {{ form.description }}
            </div>
            <div>
                <label>{% trans "Result / Execution Info" %}</label>
                {{ form.result_info }}
            </div>
        </div>


        <div style="margin-top: 30px; display: flex; justify-content: space-between; align-items: center;">
            {% if form.instance.pk %}
            <a href="{% url 'trips:download_docx' form.instance.pk %}" class="btn-primary" 
                style="text-decoration: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                üì• {% trans "Download DOCX" %}
            </a>
            {% else %}
            <div></div>
            {% endif %}
            <div>
                <a href="{% url 'trips:list' %}" class="btn-primary"
                    style="background-color: #6c757d; border-color: #6c757d; margin-right: 15px;">
                    {% trans "Cancel" %}
                </a>
                <button type="submit" class="btn-primary">{% trans "Save" %}</button>
            </div>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const regionSelect = document.querySelector('select[name="region"]');
        const institutionSelect = document.querySelector('select[name="institution"]');
        const institutionMapping = {{ institution_mapping|default: "[]" | safe
    }};

    // --- 1. Filter Institutions by Region ---
    regionSelect.addEventListener('change', function () {
        const selectedRegionId = this.value;
        const options = institutionSelect.options;

        for (let i = 0; i < options.length; i++) {
            const opt = options[i];
            if (!opt.value) continue; // Skip empty option

            const instId = parseInt(opt.value);
            const mapping = institutionMapping.find(m => m.id === instId);

            if (!selectedRegionId || (mapping && mapping.region_id == selectedRegionId)) {
                opt.style.display = '';
            } else {
                opt.style.display = 'none';
                if (opt.selected) institutionSelect.value = '';
            }
        }
    });

    // --- 2. Auto-select Region by Institution ---
    institutionSelect.addEventListener('change', function () {
        const selectedInstId = this.value;
        if (!selectedInstId) return;

        const mapping = institutionMapping.find(m => m.id == selectedInstId);
        if (mapping) {
            regionSelect.value = mapping.region_id;
        }
    });

    // Initial trigger to filter if region is already selected (e.g., on edit)
    if (regionSelect.value) {
        regionSelect.dispatchEvent(new Event('change'));
    }
    });
</script>
{% endblock %}